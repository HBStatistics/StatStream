<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Subscriber Count - StatStream</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 1rem;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        .brand-logo {
            position: absolute;
            top: 1rem;
            left: 1.5rem;
            font-size: 1.25rem;
            font-weight: 500;
        }

        .brand-logo a {
            text-decoration: none;
        }

        main {
            width: 100%;
            max-width: 500px;
            padding: 2rem;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .channel-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .channel-info img {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            object-fit: cover;
        }

        .channel-info h2 {
            font-size: 1.8rem;
            margin: 0;
        }

        .count-display {
            margin-top: 1rem;
        }

        .count-display p {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        #subscriber-count, #total-views, #total-videos {
            font-size: 4rem;
            font-weight: 700;
            margin: 0;
            word-wrap: break-word;
            font-variant-numeric: tabular-nums; /* Ensures numbers have same width for smooth animation */
        }

        #subscriber-count {
            color: #FF0000;
        }

        .chart-container {
            width: 100%;
            max-width: 800px;
            height: 250px;
            margin-top: 2rem;
        }

        #theme-toggle-btn {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            background: none;
            border: 1px solid;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s, border-color 0.3s;
        }

        /* Light Theme */
        .light-theme { background-color: #f9f9f9; color: #0f0f0f; }
        .light-theme .brand-logo a { color: #606060; }
        .light-theme main { background-color: #ffffff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .light-theme .channel-info img { border: 2px solid #eee; }
        .light-theme .channel-info h2 { color: #333; }
        .light-theme .count-display p { color: #606060; }
        .light-theme .chart-container { background-color: rgba(0,0,0,0.02); border-radius: 12px; }
        .light-theme #total-views, .light-theme #total-videos { color: #333; }
        .light-theme #theme-toggle-btn { color: #0f0f0f; border-color: #ccc; }

        /* Dark Theme */
        .dark-theme { background-color: #1a1a1a; color: #e0e0e0; }
        .dark-theme .brand-logo a { color: #b0b0b0; }
        .dark-theme main { background-color: #2a2a2a; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .dark-theme .channel-info img { border: 2px solid #444; }
        .dark-theme .channel-info h2 { color: #e0e0e0; }
        .dark-theme .count-display p { color: #b0b0b0; }
        .dark-theme .chart-container { background-color: rgba(255,255,255,0.05); border-radius: 12px; }
        .dark-theme #total-views, .dark-theme #total-videos { color: #e0e0e0; }
        .dark-theme #theme-toggle-btn { color: #e0e0e0; border-color: #333; }
    </style>
</head>
<body>
    <div class="brand-logo">
        <a href="index.html">StatStream</a>
    </div>
    <button id="theme-toggle-btn" title="Toggle Theme"></button>

    <main>
        <div class="channel-info">
            <img id="channel-logo" src="" alt="Channel Logo">
            <h2 id="channel-name">Loading Channel...</h2>
        </div>

        <div class="count-display">
            <p>Live Subscriber Count</p>
            <div id="subscriber-count">0</div>
        </div>
    </main>

    <div class="count-display">
        <p>Total Views</p>
        <div id="total-views">0</div>
    </div>

    <div class="count-display">
        <p>Total Videos</p>
        <div id="total-videos">0</div>
    </div>

    <div class="chart-container">
        <canvas id="subscriber-chart"></canvas>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const channelId = urlParams.get('channelId');

            const channelLogo = document.getElementById('channel-logo');
            const channelName = document.getElementById('channel-name');
            const subscriberCountDisplay = document.getElementById('subscriber-count');
            const totalViewsDisplay = document.getElementById('total-views');
            const totalVideosDisplay = document.getElementById('total-videos');
            let currentSubscriberCount = 0;
            let currentViewCount = 0;
            let currentVideoCount = 0;
            let subscriberChart; // Will hold the chart instance

            // --- IMPORTANT ---
            // Use the same API key you used in search.html
            const API_KEY = 'AIzaSyBgELAGkvluwfu6CNKHNDTwq20_8lckcZU';

            const animateCount = (element, start, end, duration) => {
                let startTime = null;

                const step = (timestamp) => {
                    if (!startTime) startTime = timestamp;
                    const progress = Math.min((timestamp - startTime) / duration, 1);
                    const currentNumber = Math.floor(progress * (end - start) + start);
                    element.textContent = currentNumber.toLocaleString();

                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    } else {
                        element.textContent = end.toLocaleString(); // Ensure final value is accurate
                    }
                };
                window.requestAnimationFrame(step);
            };

            const initializeChart = () => {
                const ctx = document.getElementById('subscriber-chart').getContext('2d');
                subscriberChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Subscribers',
                            data: [],
                            borderColor: '#FF0000',
                            backgroundColor: 'rgba(255, 0, 0, 0.1)',
                            fill: true,
                            tension: 0.2,
                            pointRadius: 0, // No points on the line
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'second',
                                    displayFormats: { second: 'HH:mm:ss' }
                                },
                                ticks: { maxTicksLimit: 7, color: '#888' },
                                grid: { color: 'rgba(136, 136, 136, 0.2)' }
                            },
                            y: {
                                ticks: {
                                    callback: function(value) {
                                        if (value >= 1000000) return (value / 1000000).toFixed(2) + 'M';
                                        if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
                                        return value;
                                    },
                                    color: '#888'
                                },
                                grid: { color: 'rgba(136, 136, 136, 0.2)' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        animation: { duration: 0 }
                    }
                });
            };

            const updateChart = (newCount) => {
                if (!subscriberChart) return;

                const now = Date.now();
                const chartData = subscriberChart.data.datasets[0].data;

                chartData.push({ x: now, y: newCount });
                while (chartData.length > 0 && chartData[0].x < now - 60000) {
                    chartData.shift();
                }
                subscriberChart.update('none');
            };

            if (!channelId) {
                channelName.textContent = 'Error: Channel ID not found.';
                subscriberCountDisplay.textContent = 'N/A';
                totalViewsDisplay.textContent = 'N/A';
                totalVideosDisplay.textContent = 'N/A';
                return;
            }

            const fetchChannelData = async () => {
                if (API_KEY === 'YOUR_API_KEY_HERE' || API_KEY === '') { // Check for placeholder or empty key
                    subscriberCountDisplay.innerHTML = `<p style="color: red; font-weight: bold; font-size: 1rem;">API Key not set. Please edit live-count.html to add your YouTube Data API key.</p>`;
                    return;
                }

                const youtubeApiUrl = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${channelId}&key=${API_KEY}`;

                try {
                    const youtubeResponse = await fetch(youtubeApiUrl);
                    const youtubeData = await youtubeResponse.json();

                    if (youtubeData.error) {
                        throw new Error(`YouTube API Error: ${youtubeData.error.message}`);
                    }
                    
                    if (youtubeData.items && youtubeData.items.length > 0) {
                        const channel = youtubeData.items[0];
                        const stats = channel.statistics;

                        channelLogo.src = channel.snippet.thumbnails.default.url;
                        channelLogo.alt = `Logo for ${channel.snippet.title}`;
                        channelName.textContent = channel.snippet.title;
                        
                        // Get stats directly from the YouTube API response
                        const newSubscriberCount = parseInt(stats.subscriberCount, 10);
                        const newViewCount = parseInt(stats.viewCount, 10);
                        const newVideoCount = parseInt(stats.videoCount, 10);

                        // Animate subscribers if the count has changed
                        if (newSubscriberCount !== currentSubscriberCount) {
                            animateCount(subscriberCountDisplay, currentSubscriberCount, newSubscriberCount, 1500);
                        }
                        // Update the chart with the latest count, regardless of change, to build the graph
                        updateChart(newSubscriberCount);
                        currentSubscriberCount = newSubscriberCount;

                        // Animate views if the count has changed
                        if (newViewCount !== currentViewCount) {
                            animateCount(totalViewsDisplay, currentViewCount, newViewCount, 1500);
                        }
                        currentViewCount = newViewCount;

                        // Animate videos if the count has changed
                        if (newVideoCount !== currentVideoCount) {
                            animateCount(totalVideosDisplay, currentVideoCount, newVideoCount, 1500);
                        }
                        currentVideoCount = newVideoCount;
                    } else {
                        channelName.textContent = 'Channel not found.';
                        subscriberCountDisplay.textContent = 'N/A';
                        totalViewsDisplay.textContent = 'N/A';
                        totalVideosDisplay.textContent = 'N/A';
                        currentSubscriberCount = currentViewCount = currentVideoCount = 0;
                    }
                } catch (error) {
                    console.error('Error fetching channel data from YouTube API:', error);
                    channelName.textContent = 'Error loading channel.';
                    subscriberCountDisplay.textContent = 'Error';
                    totalViewsDisplay.textContent = 'Error';
                    totalVideosDisplay.textContent = 'Error';
                    currentSubscriberCount = currentViewCount = currentVideoCount = 0;
                }
            };

            // Initial fetch when the page loads
            fetchChannelData();

            // Initialize the chart
            initializeChart();

            // Periodically update the stats. WARNING: A 2-second interval is very frequent
            // and may exhaust your daily YouTube API quota quickly. Consider a longer interval.
            setInterval(fetchChannelData, 2000);
        });
    </script>
    <script src="theme.js" defer></script>
</body>
</html>